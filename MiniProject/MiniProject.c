#include "pic32mx.h"
#include "io.h"
#include "game.h"
#include "menu.h"

int gameON = 0;
uint8_t sm[32][32] =
{
{_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_},
{_,_,_,_,_,_,_,_,_,1,1,1,1,_,_,_,_,_,_,1,1,1,1,_,_,_,_,_,_,_,_,_},
{_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_},
{_,_,_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_,_,_},
{_,_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_,_},
{_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_},
{_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_},
{_,_,1,1,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,1,1,_,_},
{_,_,1,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,1,_,_},
{_,1,1,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,1,1,_},
{_,1,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,1,_},
{_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_},
{1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1},
{1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1},
{1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1},
{1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1},
{1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1},
{1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1},
{1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1},
{1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1},
{_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_},
{_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_},
{_,1,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,1,1,_},
{_,_,1,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,1,_,_},
{_,_,1,1,_,_,_,_,_,_,_,1,1,1,1,1,1,1,1,1,1,_,_,_,_,_,_,_,1,1,_,_},
{_,_,_,1,1,_,_,_,_,_,_,_,_,1,1,1,1,1,1,_,_,_,_,_,_,_,_,1,1,_,_,_},
{_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_},
{_,_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_,_},
{_,_,_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_,_,_},
{_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_},
{_,_,_,_,_,_,_,_,_,1,1,1,1,_,_,_,_,_,_,1,1,1,1,_,_,_,_,_,_,_,_,_},
{_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_},
};

uint8_t s[8][34] =
{
{1,1,1,1,_,_,_,1,_,_,_,_,_,1,_,1,1,1,1,1,_,1,_,_,_,_,_,_,1,1,1,1,1,1},
{1,_,_,_,1,_,_,1,1,_,_,_,1,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,1,_,_,_,_,1},
{1,_,_,_,_,_,_,1,_,1,_,1,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,1,_,_,_,_,_},
{_,1,1,1,1,_,_,1,_,_,1,_,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,_,1,1,1,_,_},
{_,_,_,_,_,1,_,1,_,_,_,_,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,1,_,_,_,_,_},
{_,_,_,_,_,1,_,1,_,_,_,_,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,1,_,_,_,_,_},
{1,_,_,_,_,1,_,1,_,_,_,_,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,1,_,_,_,_,_},
{_,1,1,1,1,1,_,1,_,_,_,_,_,1,_,1,1,1,1,1,_,1,1,1,1,1,1,_,1,1,1,1,1,1},
};

struct Sprite smile;
struct Sprite text;

//The initialization routine was made based on Lab 3 files and reference manual, appendix B examples
//We have a solid understanding of this routine
void displayInit() {
	CMD_MODE_ON;
	DISPLAY_VDD_ON;						//Power on controller
	delay(1);

	spi(0xAE);							//Display off (sleep)
	DISPLAY_RESET_ON;					//Reset controller
	delay(1);
	DISPLAY_RESET_OFF;

										//Charge pump + pre-charge period commands
	spi(0x8D);
	spi(0x14);

	spi(0xD9);
	spi(0xF1);

	DISPLAY_VBATT_ON;					//Power on display
	delay(100);

										//Inert display cord system
	spi(0xA1);							//remap columns
	spi(0xC8);							//remap rows

										//Sequential COM, non-interleaved display memory (Page Mode)
	spi(0xDA);							//COM config
	spi(0x20);							//Sequential COM

	spi(0xD5);							//Set oscillator frequency and display clock divide ratio
	spi(0xF0);							//Max frequency and divide ratio of 1

	spi(0xAF);							//Display on
}

void hello() {
	int i;
	smile = (struct Sprite){ 32, 32, &sm[0][0] };
	text = (struct Sprite){ 8, 34, &s[0][0] };

	ClearDisplay;

	CMD_MODE_ON;
	spi(0x81);								//Contrast
	spi(0);
	CMD_MODE_OFF;

	drawSprite(smile, pos(47, 0));
	displayUpdate();

	CMD_MODE_ON;
	for (i = 0; i < 256; i++) {
		spi(0x81);							//Contrast
		spi(i);
		delay(10);
	}

	for (i = 255; i >= 0; i--) {
		spi(0x81);							//Contrast
		spi(i);
		delay(10);
	}

	spi(0xAE);
	delay(1000);
	CMD_MODE_OFF;
	ClearDisplay;
	drawSprite(text, pos(46, 11));
	displayUpdate();
	CMD_MODE_ON;
	spi(0xAF);

	for (i = 0; i < 256; i++) {
		spi(0x81);							//Contrast
		spi(i);
		delay(10);
	}

	for (i = 255; i >= 0; i--) {
		spi(0x81);							//Contrast
		spi(i);
		delay(10);
	}
	ClearDisplay;
	spi(0x81);							//Contrast
	spi(0x7f);

	CMD_MODE_OFF;
}

int main() {
	displayInit();
	fontInit();
	gameSetup();
	hello();

	while (1)
	{
		if (gameON) {
			game();
			scoreCheck();
			gameOver();
		}
		else {
			menu();
		}
	}

	return 0;
}

//	


